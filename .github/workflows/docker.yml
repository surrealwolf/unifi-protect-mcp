name: Build Docker Image

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  build:
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v5

      - name: Login to Harbor
        run: |
          echo "${{ secrets.HARBOR_PASSWORD }}" | docker login harbor.dataknife.net \
            -u '${{ secrets.HARBOR_USERNAME }}' \
            --password-stdin

      - name: Pull base images from Harbor cache
        run: |
          docker pull harbor.dataknife.net/dockerhub/library/golang:1.23-alpine || true
          docker pull harbor.dataknife.net/dockerhub/library/alpine:3.18 || true

      - name: Build and push Docker image
        run: |
          IMAGE_TAG="harbor.dataknife.net/library/unifi-protect-mcp"
          
          # Build with cache from Harbor
          docker build \
            --cache-from harbor.dataknife.net/library/unifi-protect-mcp:latest \
            -t ${IMAGE_TAG}:latest \
            -f Dockerfile .
          
          # Tag with commit SHA if available
          if [ -n "${{ github.sha }}" ]; then
            docker tag ${IMAGE_TAG}:latest ${IMAGE_TAG}:${{ github.sha }}
            docker push ${IMAGE_TAG}:${{ github.sha }}
          fi
          
          # Push latest tag (only on main/develop branches)
          if [[ "${{ github.ref }}" == "refs/heads/main" ]] || [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            docker push ${IMAGE_TAG}:latest
          fi

      - name: Test Docker image
        run: |
          docker run --rm harbor.dataknife.net/library/unifi-protect-mcp:latest --help || true
